"use strict";var g=require("fs"),p=process.env.GITHUB_TOKEN;p||(console.error("GITHUB_TOKEN is required"),process.exit(1));async function u(a){let r=await fetch(`https://api.github.com${a}`,{headers:{"User-Agent":"supplychain-guard",Authorization:`Bearer ${p}`,Accept:"application/vnd.github+json"}});if(!r.ok)throw new Error(`GitHub API ${r.status}: ${r.statusText}`);return r.json()}function h(){let a=process.env.GITHUB_REPOSITORY;if(!a)throw new Error("GITHUB_REPOSITORY environment variable is required");let[r,c]=a.split("/"),s="",e="HEAD";try{let i=process.env.GITHUB_EVENT_PATH;if(i){let o=JSON.parse((0,g.readFileSync)(i,"utf8"));s=o?.pull_request?.base?.sha||"",e=o?.pull_request?.head?.sha||"HEAD"}}catch{s=process.env.GITHUB_BASE_REF||"",e=process.env.GITHUB_SHA||"HEAD"}if(!s)throw new Error("Could not determine base commit SHA");return{base:s,head:e,owner:r,repo:c}}async function y(){let{base:a,head:r,owner:c,repo:s}=h();console.log(`Fetching dependency changes between ${a} and ${r}...`);try{let e=[],i=1,o=100;for(;;){console.log(`Fetching dependency changes page ${i}...`);let n=`/repos/${c}/${s}/dependency-graph/compare/${a}...${r}?per_page=${o}&page=${i}`,t=await u(n);if(!Array.isArray(t)){e=Array.isArray(t)?t:[];break}if(e.push(...t),console.log(`Page ${i}: ${t.length} changes`),t.length<o)break;if(i++,i>50){console.warn("Reached maximum page limit (50), stopping pagination");break}}return console.log(`Found total ${e.length} dependency changes across ${i} pages`),e.filter(n=>n.change_type==="added"||n.change_type==="updated").map(n=>({name:n.name,version:n.version,ecosystem:n.ecosystem,changeType:n.change_type,vulnerabilities:n.vulnerabilities||[]}))}catch(e){throw console.error(`Error fetching dependency changes: ${e instanceof Error?e.message:e}`),e}}async function m(a){let r=[];for(let c of a){let s=c.vulnerabilities.filter(e=>e.advisory.summary.toLowerCase().includes("malware")||e.advisory.description.toLowerCase().includes("malware")||e.advisory.ghsa_id.includes("malware"));s.length>0&&r.push({name:c.name,version:c.version,vulnerabilities:s})}return r}(async function(){let r=process.argv[2]||"changed.json",c=process.argv[3]||"malware-hits.json",s=String(process.argv[4]||"false")==="true";try{let e=await y(),i=e.map(n=>({name:n.name,version:n.version,ecosystem:n.ecosystem}));process.stdout.write(JSON.stringify(i,null,2));let o=await m(e);if(o.length>0){let n=`Malware vulnerabilities detected:
${o.map(t=>`- ${t.name}@${t.version}: ${t.vulnerabilities.map(d=>d.advisory.summary).join(", ")}`).join(`
`)}`;s?console.warn(n):(console.error(n),process.exit(1))}else console.log("No malware vulnerabilities detected in changed dependencies");console.error(`
Summary: ${e.length} dependencies changed`),console.error(`Malware hits: ${o.length}`);let l=e.reduce((n,t)=>n+t.vulnerabilities.length,0);l>0&&console.error(`Total vulnerabilities: ${l}`)}catch(e){console.error(`Error during dependency review: ${e instanceof Error?e.message:e}`),s?console.warn("Dependency review failed, but continuing due to warn-only mode"):process.exit(1)}})();
