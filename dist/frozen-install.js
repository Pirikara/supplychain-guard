"use strict";var o=require("child_process"),t=require("fs"),c=class{constructor(){this.name="Node.js"}detect(){return(0,t.existsSync)("package.json")}async validate(n){try{let e="";try{e=JSON.parse((0,t.readFileSync)("package.json","utf8")).packageManager||""}catch{}if(e.startsWith("yarn@")&&this.isYarnBerry())console.log("Detected Yarn Berry, performing frozen install..."),(0,o.execSync)(`echo 'checksumBehavior: "throw"' >> .yarnrc.yml`,{stdio:"inherit"}),(0,o.execSync)(n?"YARN_ENABLE_SCRIPTS=false yarn install --immutable --inline-builds":"yarn install --immutable --inline-builds",{stdio:"inherit"});else if((0,t.existsSync)("yarn.lock"))console.log("Detected Yarn Classic, performing frozen install..."),(0,o.execSync)(n?"yarn install --frozen-lockfile --ignore-scripts":"yarn install --frozen-lockfile",{stdio:"inherit"});else if((0,t.existsSync)("pnpm-lock.yaml")||e.startsWith("pnpm@")){console.log("Detected pnpm, performing frozen install...");try{(0,o.execSync)("pnpm --version",{stdio:"pipe"})}catch{(0,o.execSync)("corepack prepare pnpm@latest --activate",{stdio:"inherit"})}(0,o.execSync)(n?"pnpm install --frozen-lockfile --ignore-scripts":"pnpm install --frozen-lockfile",{stdio:"inherit"})}else(0,t.existsSync)("package-lock.json")?(console.log("Detected npm, performing frozen install..."),(0,o.execSync)(n?"npm ci --ignore-scripts":"npm ci",{stdio:"inherit"})):(console.warn("No lockfile found for Node.js project, falling back to npm ci"),(0,o.execSync)(n?"npm ci --ignore-scripts":"npm ci",{stdio:"inherit"}));return!0}catch(e){return console.error(`Node.js frozen install failed: ${e instanceof Error?e.message:e}`),!1}}isYarnBerry(){try{return!(0,o.execSync)("yarn --version",{encoding:"utf8",stdio:"pipe"}).trim().startsWith("1.")}catch{return!1}}},a=class{constructor(){this.name="Python"}detect(){return(0,t.existsSync)("requirements.txt")||(0,t.existsSync)("poetry.lock")||(0,t.existsSync)("Pipfile.lock")||(0,t.existsSync)("pyproject.toml")}async validate(n){try{return(0,t.existsSync)("poetry.lock")?(console.log("Detected Poetry, validating lockfile integrity..."),(0,o.execSync)("poetry check --lock",{stdio:"inherit"}),n?console.log("Skipping Poetry install due to ignore-scripts flag"):(0,o.execSync)("poetry install --no-dev",{stdio:"inherit"})):(0,t.existsSync)("Pipfile.lock")?(console.log("Detected Pipenv, validating lockfile integrity..."),(0,o.execSync)("pipenv verify",{stdio:"inherit"}),n?console.log("Skipping Pipenv install due to ignore-scripts flag"):(0,o.execSync)("pipenv install --deploy",{stdio:"inherit"})):(0,t.existsSync)("requirements.txt")&&(console.log("Detected pip requirements, performing dry-run validation..."),(0,o.execSync)("pip install -r requirements.txt --dry-run",{stdio:"inherit"}),n||(console.log("Installing requirements (no lockfile integrity check available)"),(0,o.execSync)("pip install -r requirements.txt",{stdio:"inherit"}))),!0}catch(e){return console.error(`Python frozen install failed: ${e instanceof Error?e.message:e}`),!1}}},d=class{constructor(){this.name="Rust"}detect(){return(0,t.existsSync)("Cargo.toml")}async validate(n){try{return(0,t.existsSync)("Cargo.lock")?(console.log("Detected Rust project with Cargo.lock, validating..."),(0,o.execSync)("cargo check --locked",{stdio:"inherit"})):(console.log("Detected Rust project without Cargo.lock, performing check..."),(0,o.execSync)("cargo check",{stdio:"inherit"})),!0}catch(e){return console.error(`Rust validation failed: ${e instanceof Error?e.message:e}`),!1}}},m=class{constructor(){this.name="Go"}detect(){return(0,t.existsSync)("go.mod")}async validate(n){try{return console.log("Detected Go project, validating go.mod and go.sum..."),(0,o.execSync)("go mod verify",{stdio:"inherit"}),(0,o.execSync)("go mod download",{stdio:"inherit"}),!0}catch(e){return console.error(`Go module validation failed: ${e instanceof Error?e.message:e}`),!1}}},p=class{constructor(){this.name="Ruby"}detect(){return(0,t.existsSync)("Gemfile")}async validate(n){try{return(0,t.existsSync)("Gemfile.lock")?(console.log("Detected Ruby project with Gemfile.lock, performing frozen install..."),(0,o.execSync)(n?"bundle install --deployment --without development test":"bundle install --deployment",{stdio:"inherit"})):(console.log("Detected Ruby project without Gemfile.lock, performing bundle install..."),(0,o.execSync)("bundle install",{stdio:"inherit"})),!0}catch(e){return console.error(`Ruby bundle install failed: ${e instanceof Error?e.message:e}`),!1}}},f=class{constructor(){this.name="PHP"}detect(){return(0,t.existsSync)("composer.json")}async validate(n){try{return(0,t.existsSync)("composer.lock")?(console.log("Detected PHP project with composer.lock, performing frozen install..."),(0,o.execSync)(n?"composer install --no-dev --no-scripts":"composer install --no-dev",{stdio:"inherit"})):(console.log("Detected PHP project without composer.lock, performing composer install..."),(0,o.execSync)(n?"composer install --no-scripts":"composer install",{stdio:"inherit"})),!0}catch(e){return console.error(`PHP composer install failed: ${e instanceof Error?e.message:e}`),!1}}};async function g(){let r=process.argv[2]||".",n=(process.argv[3]||"true")==="true";console.log(`Running frozen install check in directory: ${r}`),console.log(`Ignore scripts: ${n}`),r!=="."&&process.chdir(r);let l=[new c,new a,new d,new m,new p,new f].filter(i=>i.detect());l.length===0&&(console.warn("No supported package ecosystems detected in this directory"),process.exit(1)),console.log(`Detected ecosystems: ${l.map(i=>i.name).join(", ")}`);let s=!0;for(let i of l)console.log(`
=== Validating ${i.name} ===`),await i.validate(n)?console.log(`\u2705 ${i.name} validation succeeded`):(console.error(`\u274C ${i.name} validation failed`),s=!1);s?(console.log(`
\u{1F389} All ecosystem validations passed!`),process.exit(0)):(console.error(`
\u{1F4A5} One or more ecosystem validations failed!`),process.exit(1))}g().catch(r=>{console.error(`Unexpected error: ${r instanceof Error?r.message:r}`),process.exit(1)});
